考虑一个三元组 $a,n,b$，当 $a<b$ 时可以变为 $b,a,n$，当 $a>b$ 时可以变为 $n,b,a$，三元组 $a,1,b$ 同理。有结论至多 $n^2$ 次操作后 $1$ 和 $n$ 中的一个会被移动到序列最右侧。

> 证明：设 $1$ 在 $n$ 左侧，注意到与 $n$ 相邻的两个数的 $\min$ 不降，且连续操作中 $n$ 移动方向改变时较小值位置一定变化，即 $\min(a,b)$ 减小。假设中间任意时刻 $n$ 不在序列最右侧，可以发现至多 $n$ 次操作后 $\min(a,b)$ 会减小至少 $1$，至多 $n^2$ 次操作后 $\min(a,b)$ 会变为 $1$，即最终 $1$ 与 $n$ 相邻。形如 $1,n,a$ 的三元组一定可以一直向右移动直到最右端，得证。$1$ 在 $n$ 右侧同理。

考虑将两个序列进行一系列操作得到相同的序列。容易想到使用上述操作将 $n$ 移动到序列最右侧并得到大小为子问题 $n-1$ 的子问题。不难发现这种操作不会改变逆序对数，因此存在一种情况使得 $n$ 无法移到最右侧，但是两个序列的逆序对个数是相等的（有解的必要条件），所以第一个无法移到最右侧的 $n$ 也是相同的，因此在无法完成时把所有 $p_i$ 强制置为 $n-p_i+1$ 即可（翻转后的序列可执行的操作与原序列相同），显然如果两个序列能互相转化，翻转序列的操作位置也是相同的。

如何将 $1$ 在 $n$ 右侧的情况转为 $1$ 在 $n$ 左侧，不难发现在仅有 $n$ 个数的情况下无法完成，因此需要引入 $n+1$ 位置的数。由于存在翻转序列的操作，所以 $p_{n+1}$ 可能大于 $n$ 或者小于 $1$，分别设为 $n+1$ 和 $0$。先将 $1$ 移到最右侧，然后在 $2 \sim n$ 的子问题中将 $n$ 移到最右侧（如果 $2$ 在 $n$ 右侧则递归处理）。设右侧 $5$ 个数分别为 $a,b,n,1,p_{n+1}$。分类讨论并手玩可以得到以下可行操作：

1. $a<b,p_{n+1}=n+1$

   $a,b,n,1,n+1$ $\rightarrow$ $a,b,1,n+1,n$ $\rightarrow$ $b,1,a,n+1,n$ $\rightarrow$ $b,1,n,a,n+1$ $\rightarrow$ $b,a,1,n,n+1$

2. $a<b,p_{n+1}=0$

   $a,b,n,1,0$ $\rightarrow$ $a,n,1,b,0$ $\rightarrow$ $a,n,b,0,1$ $\rightarrow$ $b,a,n,0,1$ $\rightarrow$ $b,a,1,n,0$

3. $a>b$

   无法简单地交换 $1$ 和 $n$，考虑利用前面的数交换 $a$ 和 $b$，令 $a$ 前面的数为 $c$，再次进行分讨可得到：

   1. $c<b<a$: $c,a,b$ $\rightarrow$ $b,c,a$。
   2. $b<c<a$: $c,a,b$ $\rightarrow$ $a,b,c$。
   3. $c>a$: 无法直接操作，可以递归处理来交换 $a$ 和 $c$。

以上操作在 $n$ 过小，没有足够的数时直接返回无解，如果无法将 $1$ 和 $n$ 交换则可以直接翻转序列。每次将 $n$ 移到最右侧执行 $O(n^2)$ 次操作，总操作次数 $O(n^3)$。